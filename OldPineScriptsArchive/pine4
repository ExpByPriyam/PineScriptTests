//@version=5
strategy("UT Bot Strategy with Bollinger Bands and Dynamic SL", overlay=true)

// Inputs
a = input.float(3, title="Key Value. 'This changes the sensitivity'")
c = input.int(10, title="ATR Period")
h = input.bool(false, title="Signals from Heikin Ashi Candles", defval=false)
bbLength = input.int(30, title="Bollinger Bands Length")
bbStdDev = input.float(3, title="Bollinger Bands Standard Deviation")

xATR = ta.atr(c)
nLoss = a * xATR

src = close

var float xATRTrailingStop = na
xATRTrailingStop := (src > nz(xATRTrailingStop[1], 0) and src[1] > nz(xATRTrailingStop[1], 0)) ? math.max(nz(xATRTrailingStop[1]), src - nLoss) :
                     (src < nz(xATRTrailingStop[1], 0) and src[1] < nz(xATRTrailingStop[1], 0)) ? math.min(nz(xATRTrailingStop[1]), src + nLoss) :
                     (src > nz(xATRTrailingStop[1], 0)) ? src - nLoss : src + nLoss

ema = ta.ema(src, 1)
above = ta.crossover(ema, xATRTrailingStop)
below = ta.crossunder(ema, xATRTrailingStop)

// Bollinger Bands
[bbUpper, bbBasis, bbLower] = ta.bb(src, bbLength, bbStdDev)

buy = src > xATRTrailingStop and above 
sell = src < xATRTrailingStop and below

// Modified condition for short entry
shortCondition = sell and src < bbBasis and src > bbLower
longCondition = buy and src > bbBasis and src < bbUpper

var float stopLossLevelLong = na
var float stopLossLevelShort = na

if (longCondition)
    strategy.entry("Long", strategy.long)
    stopLossLevelLong := src - nLoss // Initial SL for long position
    strategy.exit("Exit Long SL", "Long", stop=stopLossLevelLong)
    
if (shortCondition)
    strategy.entry("Short", strategy.short)
    stopLossLevelShort := src + nLoss // Initial SL for short position
    strategy.exit("Exit Short SL", "Short", stop=stopLossLevelShort)

plotshape(buy,  title = "Buy",  text = 'Buy',  style = shape.labelup,   location = location.belowbar, color= color.green, textcolor = color.white, size = size.tiny)
plotshape(sell and not shortCondition, title = "Sell", text = 'Sell', style = shape.labeldown, location = location.abovebar, color= color.red,   textcolor = color.white, size = size.tiny)

barcolor(buy ? color.new(color.green, 0) : na)
barcolor(shortCondition ? color.new(color.red, 0)   : na)

// Plotting Bollinger Bands
plot(bbUpper, "Upper Band", color=color.red)
plot(bbBasis, "Basis (Middle Band)", color=color.blue)
plot(bbLower, "Lower Band", color=color.red)

